---
title: "HARVARDX-PH125.9x:CYO Capstone Project: Bank Marketing Campaign for Opening a Term Deposit"
author: "Deepika Dittakavi"
date: "6/15/2020"
output:
  pdf_document:
    df_print: kable
    toc: yes
    toc_depth: 4
  html_document: default
  word_document:
    toc: yes
    toc_depth: '4'
---

```{r setup, include=FALSE}
    library(knitr)
    knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=6, fig.height=4.5)
```

\pagebreak

# 1. Introduction

Marketing Campaigns are often performed to create value for customers and build strong customer relationships by focusing on the customer needs and capture value from customers in return. 

Marketing Campaigns usually focus on certail variables to devise a strategy. It mainly considers, who - the segment of population the campaign is trying to target, where/how - determines how to reach the customers by means of Telephone/TV/Radio or geographic location and finally what - the promotional offer which decides the best price to capture the customer. 

For bank marketing campaigns the main interest is to open a checking/savings account or term deposit to keep up the regular operative cash flow activities. This project primarily focuses on marketing for Term Deposit accounts.

A term deposit account is an account that the bank or financial institution offers with a fixed rate, which is often better than a regular account, where the money will be returned after the maturity time specified in the offer.

### 1.1 Data Source

This dataset is a direct marketing campaign of a Portugese banking institution. The marketing campaigns were based on phone calls where multiple contacts were made to same client. The dataset was downloaded from the Kaggle website where it mentions that data was uploaded originally in the UCI Machine Learning Repository. The dataset gives information to analyze and find ways for strategies to improve future marketing campaigns for the bank.

Kaggle Dataset: https://www.kaggle.com/janiobachmann/bank-marketing-dataset

### 1.2 Project Goal

The primary goal of the project is to analyze data, identify patterns and predict which clients will open a term deposit account. Since the outcome is to determine if the client will open or not it is a classic Classification Supervised Learning problem with two labels - yes or no.

### 1.2 Process Methodology

The process followed in the data analysis can be broadly classified into the following categories and this document follows a similar pattern.

  -Problem Definition
  -Identify Process
  -Data Wrangling
  -Data Exploration
  -Machine Learning methods
  -Results Comparison
  -Conclusion
  -Future Work

# 2. Data Wrangling

This section outlines the process followed in obtaining the data, initial setup and understanding the data.

## 2.1 Data Collection

The Kaggle website was used to download the data for the analysis. The CSV data file has been uploaded into this projects GitHub Repository and downloaded from there through the R code as shown below.


```{r getdata}
fileurl<-"https://raw.githubusercontent.com/adeepikaa/bankdeposit/master/bankdeposit.csv"
download.file(fileurl, "bank_data.csv")

bank_data<-read.csv("bank_data.csv")
```

The dataset can be found at : https://www.kaggle.com/janiobachmann/bank-marketing-dataset

## 2.2 Data Understanding

The dataset has 17 columns and 11162 rows. The data dictionary is given below.

```{r datadict}
# Data Dictionary:

#  "age"       : Age of the person 18-95
#  "job"       : Job, 22 types
#  "marital"   : Married, Single, Divorced
#  "education" : primary, secondary, tertiary, unknown
#  "default"   : has credit in default? yes/no
#  "balance"   : bank balance
#  "housing"   : has housing loan? yes/no
#  "loan"      : has personal load? yes/no
#  "contact"   : cell, telephone, unknown
#  "day"       : days of the month
#  "month"     : 12 months
#  "duration"  : duration of call, not to be used for predictions
#  "campaign"  : no. of contacts made to this person during this campaign
#  "pdays"     : number of days passed since last contact in previous campaign
#  "previous"  : number of contacts made before this campaign
#  "poutcome"  : outcome of previous marketing campaign
#  "deposit"   : Term Deposited, yes/no

head(bank_data)

str(bank_data)
```

The dataset structure shows that age, job, marital status, education, default, housing, loan, contact, month, poutcome and deposit are all categorical variables and balance, day, duration, campaign, pdays, previous are numerical continuous variables.


## 2.3 Data Tidying

This dataset did not have any missing values or duplicated rows. The data is in tidy format and ready for further analysis.

```{r dup}
sum(is.na(bank_data))

nrow(unique(bank_data))

summary(bank_data)
```

A summary on all the columns of the dataset shows a preliminary spread of the data. It can be seen that the balance can be negative for few customers. The pdays column has negative values at -1 for more than half of the customers indicating that more than half the customers were not contacted in the previous campaign. By running the following commands this has been verified through the previous column.
         
        table(bank_data$pdays)

        table(bank_data$previous)

## 2.4 Installing Packages and Libraries

```{r pkg}
if(!require(tidyverse)) install.packages("tidyverse", repos = "http://cran.us.r-project.org")
if(!require(gridExtra)) install.packages("gridExtra", repos = "http://cran.us.r-project.org")
if(!require(caret)) install.packages("caret", repos = "http://cran.us.r-project.org")
if(!require(knitr)) install.packages("knitr", repos = "http://cran.us.r-project.org")
if(!require(randomForest)) install.packages("randomForest", repos = "http://cran.us.r-project.org")
if(!require(MLmetrics)) install.packages("MLmetrics", repos = "http://cran.us.r-project.org")
if(!require(ROCR)) install.packages("ROCR", repos = "http://cran.us.r-project.org")

library(tidyverse)
library(gridExtra)
library(caret)
library(knitr)
library(randomForest)
library(MLmetrics)
library(ROCR)
library(fastAdaboost)
```


# 3 Data Exploration & Visualization


The first step to data exploration is to analyze the dependent variable across different predictors. The dependent variable is called "deposit" which indicates if the customer has ended up making a deposit or not with a "yes" or "no".

The deposit column has an almost even spread in the data.
```{r dep}
table(bank_data$deposit)
```

## 3.1 Age

The customers were aged betweeen 18 and 95 years with a median age of 39years. The below plot shows the spread of Age and deposit percent at different ages.

```{r age}
median(bank_data$age)

min(bank_data$age)

max(bank_data$age)

dist<-bank_data%>%
  group_by(age)%>%
  summarize(n=n())%>%
  ggplot(aes(x=age, y=n))+
  geom_line()+
  ggtitle(" Distribution of Age")

dist_dep<-bank_data%>%
  group_by(age)%>%
  summarize(n=n(), deposit_pct=sum(deposit=="yes")/n, .groups="drop")%>%
  ggplot(aes(x=age, y=deposit_pct))+
  geom_bar(stat="identity")+
  ggtitle(" Distribution of Deposits across Age")

grid.arrange(dist, dist_dep, ncol=1)
```

Most people above 60years and less than 25 years prefer to deposit.It can also be seen that though there are more people around 30-50 years of age a less percentage of them choose to deposit. Marketing campaigns should try to address this age group to increase customer base and continue to support the above 60years and below 25 years age groups to retain customers.



## 3.2 Education and Marital Status

Data Visualizations of different educational backgrounds and marital status revealed that people with secondary and tertiary education have shown more interest in depositing than the others. The tertiary education group has a higher percent than the secondary education group of deposits.

```{r em}
e<-bank_data%>%
  ggplot(aes(x=education,  group=deposit, fill=deposit))+
  geom_histogram(stat="count", bins=20, col="black", position="dodge")+
  ggtitle(" Distribution of Deposits across Education")+
  theme(axis.text.x = element_text(face = "bold",
                                   size = 10, angle = 45, hjust = 1, vjust = 1))

m<-bank_data%>%
  ggplot(aes(x=marital,  group=deposit, fill=deposit))+
  geom_histogram(stat="count", bins=20, col="black", position="dodge")+
  ggtitle(" Distribution of Deposits across Marital status")+
  theme(axis.text.x = element_text(face = "bold",
                                   size = 10, angle = 45, hjust = 1, vjust = 1))

grid.arrange(e,m, nrow=1)

```
The number of deposits made by married people though higher than the others has a lower percent as more number of people choose not to deposit.

Marketing campaigns should hence address the secondary education group and married group of people to increase customers.

## 3.3 Job

People with Management jobs and people who have retired are two groups that show higher interest in depositing though technicians and admin jobs are not far behind.

```{r job}
bank_data%>%
  ggplot(aes(x=job,  group=deposit, fill=deposit))+
  geom_histogram(stat="count", bins=20, col="black", position="dodge")+
  ggtitle(" Distribution of Deposits with Job")+
  theme(axis.text.x = element_text(face = "bold",
                                   size = 10, angle = 45, hjust = 1, vjust = 1))
```
```{r job2}
bank_data%>%
  ggplot()+
  geom_boxplot(aes(job, age))+
  theme(axis.text.x = element_text(face = "bold",
                                   size = 10, angle = 45, hjust = 1, vjust = 1))
```

The above plot shows the distribution of jobs across different ages. Based on the two graphs, retired people and students have shown lot of interest in doing deposits.


## 3.4 Loans and Credit default

The datasets consist of three financial categories that can decide the capabilities of a person to do a deposit - the home loan, the personal loan and credit default. Since most people do not have credit defaults even though it shows that people with defaults almost dont deposit, this variable is not the stringest predictors. However, having a housing loan can tell us more. A higher percent of people without housing loan tend to deposit than the ones having a housing loan. Also, when having a personal loan lesser number of people deposit.

The Marketing campaign should specificaly segment the population to take these prioir financial situations to approach the customers.

```{r loan}
h<-bank_data%>%
  ggplot(aes(x=housing,  group=deposit, fill=deposit))+
  geom_histogram(stat="count", bins=20, col="black", position="dodge")+
  ggtitle(" House loans")+
  theme(axis.text.x = element_text(face = "bold",
                                   size = 10, angle = 45, hjust = 1, vjust = 1))

l<-bank_data%>%
  ggplot(aes(x=loan,  group=deposit, fill=deposit))+
  geom_histogram(stat="count", bins=20, col="black", position="dodge")+
  ggtitle(" Personal loans")+
  theme(axis.text.x = element_text(face = "bold",
                                   size = 10, angle = 45, hjust = 1, vjust = 1))
d<-bank_data%>%
  ggplot(aes(x=default,  group=deposit, fill=deposit))+
  geom_histogram(stat="count", bins=20, col="black", position="dodge")+
  ggtitle(" Credit Default")+
  theme(axis.text.x = element_text(face = "bold",
                                   size = 10, angle = 45, hjust = 1, vjust = 1))
grid.arrange(h,l,d, nrow=1)
```

## 3.5 Contact type

The type of contact chart shows that mostly cellular contact was used and had better success than the others.

```{r loan}
bank_data%>%
  ggplot(aes(x=contact,  group=deposit, fill=deposit))+
  geom_histogram(stat="count", bins=20, col="black", position="dodge")+
  ggtitle(" Distribution of Deposits with different types of contact")+
  theme(axis.text.x = element_text(face = "bold",
                                   size = 10, angle = 45, hjust = 1, vjust = 1))
```

## 3.6 Contacts for current campaign

May seems to be the month with maximum contacts to people thpugh it resulted in lesser percent of deposits compared to October, September, April, December and February.

```{r this}
mon<-bank_data%>%
  ggplot(aes(x=month,  group=deposit, fill=deposit))+
  geom_histogram(stat="count", bins=20, col="black", position="dodge")+
  ggtitle("Last contact Month for current campaign")+
  theme(axis.text.x = element_text(face = "bold",
                                   size = 10, angle = 45, hjust = 1, vjust = 1))
day<-bank_data%>%
  ggplot(aes(x=day,  group=deposit, fill=deposit))+
  geom_histogram(stat="count", bins=20, col="black", position="dodge")+
  ggtitle("Last contact day for current campaign")+
  theme(axis.text.x = element_text(face = "bold",
                                   size = 10, angle = 45, hjust = 1, vjust = 1))
grid.arrange(mon, day, nrow=1)

bank_data%>%
  ggplot(aes(x=campaign,  group=deposit, fill=deposit))+
  geom_histogram(stat="count", bins=20, col="black", position="dodge")+
  ggtitle("Number of contacts for current campaign")

```

As the number of contacts increased the chances of getting deposits has decreased. Therefore campaigns should focus on lesser number of contacts but be effective.

## 3.7 Contacts for previous campaign

Previous Campaign outcomes chart shows that while most of previous outcome is unknown about 1000 of them who deposited prviously have deposited in the current campaign too. About half of them chose not deposit either times. 

```{r prev}
bank_data%>%
  ggplot(aes(x=poutcome,  group=deposit, fill=deposit))+
  geom_histogram(stat="count", bins=20, col="black", position="dodge")+
  ggtitle(" Distribution of Deposits with previous outcomes")
  
bank_data%>%
  ggplot(aes(x=pdays,  group=deposit, fill=deposit))+
  geom_histogram(stat="count", bins=20, col="black", position="dodge")+
  ggtitle(" Days since last contact")+
  xlim(c(0,400))

bank_data%>%
  ggplot(aes(x=previous,  group=deposit, fill=deposit))+
  geom_histogram(stat="count", bins=20, col="black", position="dodge")+
  ggtitle(" Contacts before this campaign")

```  
  
The number of days since last contact shows local maximums indicating that contacts were made every three months. Though the number of deposits made was higher during first contact higher percent of deposits were made in subsequent contacts.  
  
## 3.8 Bank Balance

Bank balance is an important factor to be able to do a deposit. It vaired from -6847$ to 81204$ with median balance of 550$. The below chart shows that the most balances were from 100$ to 1100$ and the median balance of people who deposited was slightly higher than the people who did not deposit.

```{r bal}
median(bank_data$balance)

min(bank_data$balance)

max(bank_data$balance)

bal1<-bank_data%>%
  ggplot(aes(x=deposit, y=balance, col=deposit))+
  geom_boxplot()+
  ggtitle("Distribution of Bank balance")
 
bal2<-bank_data%>%
  ggplot(aes(x=deposit, y=balance, col=deposit))+
  geom_boxplot()+
  ggtitle("Distribution of Bank balance")+
  ylim(0, 2500)

grid.arrange(bal1, bal2, nrow=1)
```

The below charts show how balances vary with different other factors.
```{r bal2}
bank_data%>%
  ggplot(aes(x=age, y=balance))+
  geom_point()+
  ggtitle(" Bank Balance for different ages")

bank_data%>%
  ggplot(aes(x=job,  y=balance))+
  geom_bar(stat="identity")+
  ggtitle(" Balance for different jobs")+
  theme(axis.text.x = element_text(face = "bold",
                                   size = 10, angle = 45, hjust = 1, vjust = 1))

b1<-bank_data%>%
  ggplot(aes(x=education,  y=balance))+
  geom_bar(stat="identity")+
  ggtitle(" Balance for different Education")+
  theme(axis.text.x = element_text(face = "bold",
                                   size = 10, angle = 45, hjust = 1, vjust = 1))

b2<-bank_data%>%
  ggplot(aes(x=marital,  y=balance))+
  geom_bar(stat="identity")+
  ggtitle(" Balance for Marital Status")+
  theme(axis.text.x = element_text(face = "bold",
                                   size = 10, angle = 45, hjust = 1, vjust = 1))
grid.arrange(b1, b2, nrow=1)

h_b<-bank_data%>%
  ggplot(aes(x=housing,  y=balance))+
  geom_bar(stat="identity")+
  ggtitle(" Balance with Housing loan")+
  theme(axis.text.x = element_text(face = "bold",
                                   size = 10, angle = 45, hjust = 1, vjust = 1))

l_b<-bank_data%>%
  ggplot(aes(x=loan,  y=balance))+
  geom_bar(stat="identity")+
  ggtitle(" Balance with Personal loan")+
  theme(axis.text.x = element_text(face = "bold",
                                   size = 10, angle = 45, hjust = 1, vjust = 1))
d_b<-bank_data%>%
  ggplot(aes(x=default,  y=balance))+
  geom_bar(stat="identity")+
  ggtitle(" Balance with Credit Default")+
  theme(axis.text.x = element_text(face = "bold",
                                   size = 10, angle = 45, hjust = 1, vjust = 1))

grid.arrange(h_b, l_b, d_b, nrow=1)
```

## 3.9 Correlation

The corelation analysis was performed with the duration column as it is heavily correlated with successful deposit. As per suggestion from the Kaggle and UCI Ml websites the duration column must be excluded from running predictions because the duration of the call will be longer after it is decided that the customer wants to make a deposit.

```{r cor}
cor(bank_data[,c("previous", "campaign","pdays", "age", "balance")], bank_data$duration)

cortable<-cor(bank_data[,c("age", "balance", "duration", "campaign", "pdays", "previous")])
col<- colorRampPalette(c("blue", "white", "red"))(20)
heatmap(cortable, col=col, symm=TRUE)

cor(bank_data[,c("previous", "campaign","pdays", "age", "balance")], bank_data$duration)
```

The corelation heatmap also shows that most variables are correlated with each other.

# 4 Data Analysis & Methods

The dataset has been divied into train test and evaluation sets to predict if a customer will do a term deposit. 

## 4.1 Data Splitting

The train set will be used for training the model and test set to fine tune compare different models. Once a final model has been chosen then the evaluation set can be used to validate the model. The data has been with a 80%-20% ratio.

The pdays and duration column have been removed to run predictive analysis. The pdays column has been removed as more than half of the customers have not been contacted before.

```{r data}
bank_data_ml<-bank_data[, -c(12, 14)]

set.seed(123)

test_index <- createDataPartition(bank_data_ml$deposit, times = 1, p = 0.2, list = FALSE)
temp <- bank_data_ml[-test_index,]
evalset <- bank_data_ml[test_index,]

set.seed(123)

test_index <- createDataPartition(temp$deposit, times = 1, p = 0.2, list = FALSE)
trainset <- temp [-test_index,]
testset <- temp [test_index,]
```

## 4.2 Output Measuring method

This dataset uses Supervised Classification algorithms to run different models. It is important to define the correct output measurements for comparison. The classification models usually use accuracy to measure the quality of a model. However, other measures like sensitivity, specificity, F1 score and Area under the ROC curve can be important to describe how well the model predicts the correct values.

The table giving the correct and wrong values is called the Confusion Matrix.



## 4.3 Machine Learning Models

### 4.3.1 NB

### 4.3.2 GLM

### 4.3.3 KNN

### 4.3.4 CART

### 4.3.5 Random Forest

### 4.3.6 Gradient Boosting

### 4.3.6 Model Result Comparison

# 5 Conclusion

## 5.1 Summary

## 5.2 Future Work

# 6 References

